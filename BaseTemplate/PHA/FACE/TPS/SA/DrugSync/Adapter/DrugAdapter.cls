Class PHA.FACE.TPS.SA.DrugSync.Adapter.DrugAdapter
{

/// Author: valen MPF
/// Date: 2025-11-28
/// Description: Parse incoming SA JSON and map SA fields + HIS fields into DrugDTO.
ClassMethod FromJSON(jsonStr As %String) As PHA.FACE.TPS.SA.DrugSync.DTO.DrugDTO
{
    set dto = ##class(PHA.FACE.TPS.SA.DrugSync.DTO.DrugDTO).%New()

    if jsonStr'="" {
	    //set dyn = ##class(%DynamicObject).%FromJSON(jsonStr)
        set dyn = ##class(PHA.COM.JSONUtils).ToObject(jsonStr)
    } else {
        set dyn = {}.%New()
    }

    // Map SA input fields (使用正确的字段名)
    set dto.AdvsalePrice = ..GetStringValue(dyn.%Get("AdvsalePrice"))
    set dto.CompId = ..GetStringValue(dyn.%Get("CompId"))
    set dto.FactoryId = ..GetStringValue(dyn.%Get("FactoryId"))
    set dto.FactoryName = ..GetStringValue(dyn.%Get("FactoryName"))	
    set dto.InitTime = ..GetStringValue(dyn.%Get("InitTime"))
    set dto.InitUser = ..GetStringValue(dyn.%Get("InitUser"))
    set dto.IsInsurance = ..GetStringValue(dyn.%Get("IsInsurance"))
    set dto.LastModify = ..GetStringValue(dyn.%Get("LastModify"))
    set dto.LastTime = ..GetStringValue(dyn.%Get("LastTime"))
    set dto.MaxQty = ..GetStringValue(dyn.%Get("MaxQty"))
    set dto.MidQty = ..GetStringValue(dyn.%Get("MidQty"))
    set dto.WareUnit = ..GetStringValue(dyn.%Get("WareUnit"))
    set dto.MinQty = ..GetStringValue(dyn.%Get("MinQty"))
    set dto.MinUnit = ..GetStringValue(dyn.%Get("MinUnit"))
    set dto.Pile = ..GetStringValue(dyn.%Get("Pile"))
    set dto.PurStatus = ..GetStringValue(dyn.%Get("PurStatus"))
    set dto.SaleStatus = ..GetStringValue(dyn.%Get("SaleStatus"))
    set dto.SaleTax = ..GetStringValue(dyn.%Get("SaleTax"))
    set dto.Status = ..GetStringValue(dyn.%Get("Status"))
    set dto.WareAbc = ..GetStringValue(dyn.%Get("WareAbc"))
    set dto.WareCode = ..GetStringValue(dyn.%Get("WareCode"))
    set dto.WareName = ..GetStringValue(dyn.%Get("WareName"))
    set dto.WaregeneralName = ..GetStringValue(dyn.%Get("WaregeneralName"))
    set dto.WareKind = ..GetStringValue(dyn.%Get("WareKind"))
    set dto.WareSpec = ..GetStringValue(dyn.%Get("WareSpec"))
    set dto.WarningDays = ..GetStringValue(dyn.%Get("WarningDays"))
    set dto.AreaCode = ..GetStringValue(dyn.%Get("AreaCode"))
    set dto.AreaName = ..GetStringValue(dyn.%Get("AreaName"))
    set dto.BarCode = ..GetStringValue(dyn.%Get("BarCode"))
    set dto.ExtNo = ..GetStringValue(dyn.%Get("ExtNo"))
    set dto.FileNo = ..GetStringValue(dyn.%Get("FileNo"))
    set dto.ListingHolder = ..GetStringValue(dyn.%Get("ListingHolder"))
    set dto.MinBarcode = ..GetStringValue(dyn.%Get("MinBarcode"))
    set dto.MinOutQty = ..GetStringValue(dyn.%Get("MinOutQty"))
    set dto.Notes = ..GetStringValue(dyn.%Get("Notes"))
    set dto.PurTaxX = ..GetStringValue(dyn.%Get("PurTaxX"))
    set dto.PurTaxY = ..GetStringValue(dyn.%Get("PurTaxY"))
    set dto.ScanFlag = ..GetStringValue(dyn.%Get("ScanFlag"))
    set dto.StoreReq = ..GetStringValue(dyn.%Get("StoreReq"))
    set dto.WareType = ..GetStringValue(dyn.%Get("WareType"))
    set dto.ChemElement = ..GetStringValue(dyn.%Get("ChemElement"))
    set dto.ChemName = ..GetStringValue(dyn.%Get("ChemName"))
    set dto.DoubleCheck = ..GetStringValue(dyn.%Get("DoubleCheck"))
    set dto.Efficacy = ..GetStringValue(dyn.%Get("Efficacy"))
    set dto.Instructions = ..GetStringValue(dyn.%Get("Instructions"))
    set dto.MainElement = ..GetStringValue(dyn.%Get("MainElement"))
    set dto.MaintainType = ..GetStringValue(dyn.%Get("MaintainType"))
    set dto.PHCCCode = ..GetStringValue(dyn.%Get("PHCCCode"))
    set dto.PHCCCat = ..GetStringValue(dyn.%Get("PHCCCat"))
    set dto.HisPhisId = ..GetStringValue(dyn.%Get("HisPhisId"))
    set dto.HisPhis = ..GetStringValue(dyn.%Get("HisPhis"))
    set dto.HisChisId = ..GetStringValue(dyn.%Get("HisChisId"))
    set dto.HisChis = ..GetStringValue(dyn.%Get("HisChis"))
    set dto.HisChisBM = ..GetStringValue(dyn.%Get("HisChisBM"))
    set dto.YPJXCode = ..GetStringValue(dyn.%Get("YPJXCode"))
    set dto.YPJXName = ..GetStringValue(dyn.%Get("YPJXName"))
    set dto.HisZDL = ..GetStringValue(dyn.%Get("HisZDL"))
    set dto.Hisjxyl = ..GetStringValue(dyn.%Get("Hisjxyl"))
    set dto.Hisdczdjl = ..GetStringValue(dyn.%Get("Hisdczdjl"))
    set dto.Hismrzdjl = ..GetStringValue(dyn.%Get("Hismrzdjl"))
    set dto.scSGCode = ..GetStringValue(dyn.%Get("scSGCode"))
    set dto.scSGDesc = ..GetStringValue(dyn.%Get("scSGDesc"))
    set dto.scSCCode = ..GetStringValue(dyn.%Get("scSCCode"))
    set dto.scSCDesc = ..GetStringValue(dyn.%Get("scSCDesc"))
    set dto.ARCIMEffDate = ..GetStringValue(dyn.%Get("ARCIMEffDate"))
    set dto.ARCIMEffDateTo = ..GetStringValue(dyn.%Get("ARCIMEffDateTo"))
    set dto.ORCATCode = ..GetStringValue(dyn.%Get("ORCATCode"))
    set dto.ARCICCode = ..GetStringValue(dyn.%Get("ARCICCode"))
    set dto.ARCSGCode = ..GetStringValue(dyn.%Get("ARCSGCode"))
    set dto.TARSCCode = ..GetStringValue(dyn.%Get("TARSCCode"))
    set dto.TARICCode = ..GetStringValue(dyn.%Get("TARICCode"))
    set dto.TAROCCode = ..GetStringValue(dyn.%Get("TAROCCode"))
    set dto.TARECCode = ..GetStringValue(dyn.%Get("TARECCode"))
    set dto.TARACCode = ..GetStringValue(dyn.%Get("TARACCode"))
    set dto.TARMCCode = ..GetStringValue(dyn.%Get("TARMCCode"))
    set dto.NTARMCCode = ..GetStringValue(dyn.%Get("NTARMCCode"))
    set dto.INFOBasicDrug = ..GetStringValue(dyn.%Get("INFOBasicDrug"))
    set dto.INFOImportFlag = ..GetStringValue(dyn.%Get("INFOImportFlag"))
    set dto.YPXQ = ..GetStringValue(dyn.%Get("YPXQ"))
    set dto.UpdateFlag = ..GetStringValue(dyn.%Get("UpdateFlag"))

    // Map HIS INCI fields
    set dto.inciArcim = ..GetStringValue(dyn.%Get("inciArcim"))
    set dto.inciCode = ..GetStringValue(dyn.%Get("WareCode"))		// inciCode
    set dto.inciDesc = ..GetStringValue(dyn.%Get("WareName"))
    set dto.inciBUom = ..GetStringValue(dyn.%Get("inciBUom"))
    set dto.inciPUom = ..GetStringValue(dyn.%Get("inciPUom"))
    set dto.inciPUom4TCode = ..GetStringValue(dyn.%Get("inciPUom4TCode"))
    set dto.inciOutUom = ..GetStringValue(dyn.%Get("inciOutUom"))
    set dto.inciInUom = ..GetStringValue(dyn.%Get("inciInUom"))
    set dto.inciStkCat = ..GetStringValue(dyn.%Get("inciStkCat"))
    set dto.inciBookCat = ..GetStringValue(dyn.%Get("inciBookCat"))
    set dto.inciExpReq = ..GetStringValue(dyn.%Get("inciExpReq"))
    set dto.inciExpLen = ..GetStringValue(dyn.%Get("inciExpLen"))
    set dto.inciManf = ..GetStringValue(dyn.%Get("inciManf"))
    set dto.inciSpec = ..GetStringValue(dyn.%Get("inciSpec"))
    set dto.inciOrigin = ..GetStringValue(dyn.%Get("inciOrigin"))
    set dto.inciMarkType = ..GetStringValue(dyn.%Get("inciMarkType"))
    set dto.inciRp = ..GetStringValue(dyn.%Get("inciRp"))
    set dto.inciSp = ..GetStringValue(dyn.%Get("inciSp"))
    set dto.inciMaxSp = ..GetStringValue(dyn.%Get("inciMaxSp"))
    set dto.inciPriceDate = ..GetStringValue(dyn.%Get("inciPriceDate"))
    set dto.inciPrcFile = ..GetStringValue(dyn.%Get("inciPrcFile"))
    set dto.inciPrcFileDate = ..GetStringValue(dyn.%Get("inciPrcFileDate"))
    set dto.inciBarCode = ..GetStringValue(dyn.%Get("inciBarCode"))
    set dto.inciStandardCode = ..GetStringValue(dyn.%Get("inciStandardCode"))
    set dto.inciImport = ..GetStringValue(dyn.%Get("inciImport"))
    set dto.inciComeFrom = ..GetStringValue(dyn.%Get("inciComeFrom"))
    set dto.inciQualityNo = ..GetStringValue(dyn.%Get("inciQualityNo"))
    set dto.inciQualityLev = ..GetStringValue(dyn.%Get("inciQualityLev"))
    set dto.inciInMedBasis = ..GetStringValue(dyn.%Get("inciInMedBasis"))
    set dto.inciDrugUse = ..GetStringValue(dyn.%Get("inciDrugUse"))
    set dto.inciPackUom = ..GetStringValue(dyn.%Get("inciPackUom"))
    set dto.inciPackUomFac = ..GetStringValue(dyn.%Get("inciPackUomFac"))
    set dto.inciReportingDays = ..GetStringValue(dyn.%Get("inciReportingDays"))
    set dto.inciRRReason = ..GetStringValue(dyn.%Get("inciRRReason"))
    set dto.inciPurPlanCode = ..GetStringValue(dyn.%Get("inciPurPlanCode"))
    set dto.dmDrugIdByself = ..GetStringValue(dyn.%Get("dmDrugIdByself"))
    set dto.inciRemark1 = ..GetStringValue(dyn.%Get("inciRemark1"))
    set dto.inciRemark2 = ..GetStringValue(dyn.%Get("inciRemark2"))
    set dto.inciBAFlag = ..GetStringValue(dyn.%Get("inciBAFlag"))
    set dto.inciCentralPur = ..GetStringValue(dyn.%Get("inciCentralPur"))
    set dto.inciNegoFlag = ..GetStringValue(dyn.%Get("inciNegoFlag"))
    set dto.inciInHosp = ..GetStringValue(dyn.%Get("inciInHosp"))
    set dto.inciRecFlag = ..GetStringValue(dyn.%Get("inciRecFlag"))
    set dto.inciSHCentPurFlag = ..GetStringValue(dyn.%Get("inciSHCentPurFlag"))
    set dto.inciSkinTest = ..GetStringValue(dyn.%Get("inciSkinTest"))
    set dto.inciEasyConfuse = ..GetStringValue(dyn.%Get("inciEasyConfuse"))
    set dto.inciEdible = ..GetStringValue(dyn.%Get("inciEdible"))
    set dto.inciTemPurchase = ..GetStringValue(dyn.%Get("inciTemPurchase"))
    set dto.inciHighPrice = ..GetStringValue(dyn.%Get("inciHighPrice"))
    set dto.inciWholeDispFlag = ..GetStringValue(dyn.%Get("inciWholeDispFlag"))
    set dto.incPropNoTraceCode = ..GetStringValue(dyn.%Get("incPropNoTraceCode"))
    set dto.inciOrdEdDate = ..GetStringValue(dyn.%Get("inciOrdEdDate"))
    set dto.inciNotUse = ..GetStringValue(dyn.%Get("inciNotUse"))
    set dto.inciNotUseRea = ..GetStringValue(dyn.%Get("inciNotUseRea"))
    set dto.tarCode = ..GetStringValue(dyn.%Get("WareCode"))
    set dto.tarDesc = ..GetStringValue(dyn.%Get("WareName"))
    set dto.tarMCCateNew = ..GetStringValue(dyn.%Get("tarMCCateNew"))
    set dto.tarMCCate = ..GetStringValue(dyn.%Get("tarMCCate"))
    set dto.tarOutpatCate = ..GetStringValue(dyn.%Get("tarOutpatCate"))
    set dto.tarInpatCate = ..GetStringValue(dyn.%Get("tarInpatCate"))
    set dto.tarEMCCate = ..GetStringValue(dyn.%Get("tarEMCCate"))
    set dto.tarAcctCate = ..GetStringValue(dyn.%Get("tarAcctCate"))
    set dto.tarSubCate = ..GetStringValue(dyn.%Get("tarSubCate"))
    set dto.tarInsuCode = ..GetStringValue(dyn.%Get("tarInsuCode"))
    set dto.tarInsuDesc = ..GetStringValue(dyn.%Get("tarInsuDesc"))
    set dto.inciPbFlag = ..GetStringValue(dyn.%Get("inciPbFlag"))
    set dto.inciPbVendor = ..GetStringValue(dyn.%Get("inciPbVendor"))
    set dto.inciPbLevel = ..GetStringValue(dyn.%Get("inciPbLevel"))
    set dto.inciPbManf = ..GetStringValue(dyn.%Get("inciPbManf"))
    set dto.inciPbList = ..GetStringValue(dyn.%Get("inciPbList"))
    set dto.inciPbCarrier = ..GetStringValue(dyn.%Get("inciPbCarrier"))
    set dto.inciPbRp = ..GetStringValue(dyn.%Get("inciPbRp"))

    // Map HIS ARCIM fields
    set dto.phcGene = ..GetStringValue(dyn.%Get("phcGene"))
    set dto.arcimCode = ..GetStringValue(dyn.%Get("WareCode"))	// arcimCode
    set dto.arcimDesc = ..GetStringValue(dyn.%Get("WareName"))
    set dto.arcimOrdCat = ..GetStringValue(dyn.%Get("arcimOrdCat"))
    set dto.arcimItemCat = ..GetStringValue(dyn.%Get("arcimItemCat"))
    set dto.arcimBillGrp = ..GetStringValue(dyn.%Get("arcimBillGrp"))
    set dto.arcimBillSub = ..GetStringValue(dyn.%Get("arcimBillSub"))
    set dto.arcimPri = ..GetStringValue(dyn.%Get("arcimPri"))
    set dto.arcimNoOfCumDays = ..GetStringValue(dyn.%Get("arcimNoOfCumDays"))
    set dto.arcimMaxQty = ..GetStringValue(dyn.%Get("arcimMaxQty"))
    set dto.arcimWarnQty = ..GetStringValue(dyn.%Get("arcimWarnQty"))
    set dto.arcimMaxCumDose = ..GetStringValue(dyn.%Get("arcimMaxCumDose"))
    set dto.arcimMaxQtyDay = ..GetStringValue(dyn.%Get("arcimMaxQtyDay"))
    set dto.arcimPartialValue = ..GetStringValue(dyn.%Get("arcimPartialValue"))
    set dto.arcimOPPartialValue = ..GetStringValue(dyn.%Get("arcimOPPartialValue"))
    set dto.arcimStDate = ..GetStringValue(dyn.%Get("arcimStDate"))
    set dto.arcimEdDate = ..GetStringValue(dyn.%Get("arcimEdDate"))
    set dto.arcimOEMsg = ..GetStringValue(dyn.%Get("arcimOEMsg"))
    set dto.arcimOwn = ..GetStringValue(dyn.%Get("arcimOwn"))
    set dto.arcimWoStock = ..GetStringValue(dyn.%Get("arcimWoStock"))
    set dto.arcimFree = ..GetStringValue(dyn.%Get("arcimFree"))
    set dto.arcimOP = ..GetStringValue(dyn.%Get("arcimOP"))
    set dto.arcimEM = ..GetStringValue(dyn.%Get("arcimEM"))
    set dto.arcimIP = ..GetStringValue(dyn.%Get("arcimIP"))
    set dto.arcimHP = ..GetStringValue(dyn.%Get("arcimHP"))
    set dto.phcIPOneDay = ..GetStringValue(dyn.%Get("phcIPOneDay"))
    set dto.arcimCMAllowDecimal = ..GetStringValue(dyn.%Get("arcimCMAllowDecimal"))
    set dto.phcUom = ..GetStringValue(dyn.%Get("phcUom"))
    set dto.phcSpec = ..GetStringValue(dyn.%Get("phcSpec"))
    set dto.phcPoison = ..GetStringValue(dyn.%Get("phcPoison"))
    set dto.phcFreq = ..GetStringValue(dyn.%Get("phcFreq"))
    set dto.phcInstuc = ..GetStringValue(dyn.%Get("phcInstuc"))
    set dto.phcDura = ..GetStringValue(dyn.%Get("phcDura"))
    set dto.phcHighRisk = ..GetStringValue(dyn.%Get("phcHighRisk"))
    set dto.phcOTC = ..GetStringValue(dyn.%Get("phcOTC"))
    set dto.phcLabel21 = ..GetStringValue(dyn.%Get("phcLabel21"))
    set dto.phcLabel22 = ..GetStringValue(dyn.%Get("phcLabel22"))
    set dto.phcLabel1 = ..GetStringValue(dyn.%Get("phcLabel1"))
    set dto.phcSpeed = ..GetStringValue(dyn.%Get("phcSpeed"))
    set dto.phcWHODDD = ..GetStringValue(dyn.%Get("phcWHODDD"))
    set dto.phcWHODDDUom = ..GetStringValue(dyn.%Get("phcWHODDDUom"))
    set dto.phcDDD = ..GetStringValue(dyn.%Get("phcDDD"))
    set dto.phcWHONET = ..GetStringValue(dyn.%Get("phcWHONET"))
    set dto.phcAntiLevel = ..GetStringValue(dyn.%Get("phcAntiLevel"))
    set dto.phcCHSpec = ..GetStringValue(dyn.%Get("phcCHSpec"))
    set dto.phcGranulesFac = ..GetStringValue(dyn.%Get("phcGranulesFac"))
    set dto.phcBaseDrug = ..GetStringValue(dyn.%Get("phcBaseDrug"))
    set dto.phcBaseDrugPro = ..GetStringValue(dyn.%Get("phcBaseDrugPro"))
    set dto.phcBaseDrugCity = ..GetStringValue(dyn.%Get("phcBaseDrugCity"))
    set dto.phcBaseDrugCou = ..GetStringValue(dyn.%Get("phcBaseDrugCou"))
    set dto.phcOPOneDay = ..GetStringValue(dyn.%Get("phcOPOneDay"))
    set dto.phcOPSkin = ..GetStringValue(dyn.%Get("phcOPSkin"))
    set dto.phcIPSkin = ..GetStringValue(dyn.%Get("phcIPSkin"))
    set dto.phcCodeX = ..GetStringValue(dyn.%Get("phcCodeX"))
    set dto.phcProComm = ..GetStringValue(dyn.%Get("phcProComm"))
    set dto.phcTest = ..GetStringValue(dyn.%Get("phcTest"))
    set dto.phcTPN = ..GetStringValue(dyn.%Get("phcTPN"))
    set dto.phcAnti = ..GetStringValue(dyn.%Get("phcAnti"))
    set dto.phcCritical = ..GetStringValue(dyn.%Get("phcCritical"))
    set dto.phcMonitor = ..GetStringValue(dyn.%Get("phcMonitor"))
    set dto.phcSingle = ..GetStringValue(dyn.%Get("phcSingle"))
    set dto.phcChemotherapeutic = ..GetStringValue(dyn.%Get("phcChemotherapeutic"))
    set dto.phcDietTaboo = ..GetStringValue(dyn.%Get("phcDietTaboo"))
    set dto.phcTumble = ..GetStringValue(dyn.%Get("phcTumble"))
    set dto.phcDope = ..GetStringValue(dyn.%Get("phcDope"))
    set dto.phcAllergy = ..GetStringValue(dyn.%Get("phcAllergy"))
    set dto.phcCQZT = ..GetStringValue(dyn.%Get("phcCQZT"))
    set dto.phcONE = ..GetStringValue(dyn.%Get("phcONE"))
    set dto.phcOM = ..GetStringValue(dyn.%Get("phcOM"))
    set dto.phcFirstAid = ..GetStringValue(dyn.%Get("phcFirstAid"))
    set dto.phcNoAllergy = ..GetStringValue(dyn.%Get("phcNoAllergy"))

    quit dto
}

/// Helper method to safely get string values
ClassMethod GetStringValue(value As %String) As %String
{
    if $isobject(value) {
        quit value.%ToJSON()
    }
    quit $get(value)
}

}
